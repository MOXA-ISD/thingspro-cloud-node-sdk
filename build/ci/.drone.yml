---
kind: pipeline
name: main-pipe

platform:
  os: linux
  arch: amd64

steps:
- name: restore-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    region: ap-northeast-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY

- name: setup-deps-node
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:node-12-v1
  commands:
  - make deps
  depends_on:
  - restore-cache

- name: integration-test
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:node-12-v1
  commands:
  - make test
  depends_on:
  - setup-deps-node

- name: release-it
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:node-12-v1
  commands:
  - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
  - cat .npmrc
  - make release
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY
    NPM_TOKEN:
      from_secret: NPM_TOKEN
  depends_on:
  - integration-test

- name: rebuild-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    rebuild: true
    region: ap-northeast-1
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY
  depends_on:
  - setup-deps-node

trigger:
  branch:
  - main
  event:
  - push

...
