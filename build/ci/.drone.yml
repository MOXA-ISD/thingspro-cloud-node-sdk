---
kind: pipeline
name: test-pipe

platform:
  os: linux
  arch: amd64

steps:
- name: restore-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    region: ap-northeast-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY

- name: setup-deps
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make deps
  depends_on:
  - restore-cache

- name: lint
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make lint
  depends_on:
  - setup-deps

- name: rebuild-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    rebuild: true
    region: ap-northeast-1
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY
  depends_on:
  - integration-test

trigger:
  branch:
    exclude:
    - develop
    - stage
    - master
  event:
    exclude:
    - tag

---
kind: pipeline
name: develop-pipe

platform:
  os: linux
  arch: amd64

steps:
- name: restore-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    region: ap-northeast-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY

- name: setup-deps
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make deps
  depends_on:
  - restore-cache

- name: setup-aws-cli
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/docker:dind-cloud
  commands:
  - make deps-py VENV_TYPE=dkr
  depends_on:
  - restore-cache

- name: lint
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make lint
  depends_on:
  - setup-deps

- name: build
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make build
  depends_on:
  - setup-deps

- name: release
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make pre-release VERSION=${DRONE_BRANCH//\//-}-${DRONE_COMMIT_SHA:0:8} ENV=dev
  environment:
    GITHUB_TOKEN:
      from_secret: GITHUB_TOKEN
  depends_on:
  - build
  - integration-test

- name: rebuild-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    rebuild: true
    region: ap-northeast-1
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY
  depends_on:
  - notify

volumes:
- name: docker
  host:
    path: /var/run/docker.sock
- name: docker-token
  host:
    path: /root/.docker/config.json

trigger:
  branch:
  - develop
  event:
  - push

---
kind: pipeline
name: stage-pipe

platform:
  os: linux
  arch: amd64

steps:
- name: restore-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    region: ap-northeast-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY

- name: setup-deps
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make deps
  depends_on:
  - restore-cache

- name: setup-aws-cli
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/docker:dind-cloud
  commands:
  - make deps-py VENV_TYPE=dkr
  depends_on:
  - restore-cache

- name: lint
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make lint
  depends_on:
  - setup-deps

- name: build
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make build
  depends_on:
  - setup-deps

- name: release
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make release
  environment:
    GITHUB_TOKEN:
      from_secret: GITHUB_TOKEN
  depends_on:
  - build
  - integration-test

- name: rebuild-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    rebuild: true
    region: ap-northeast-1
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY
  depends_on:
  - notify

volumes:
- name: docker
  host:
    path: /var/run/docker.sock
- name: docker-token
  host:
    path: /root/.docker/config.json

trigger:
  branch:
  - stage
  event:
  - push

---
kind: pipeline
name: production-pipe

platform:
  os: linux
  arch: amd64

steps:
- name: restore-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    region: ap-northeast-1
    restore: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY

- name: setup-deps
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - make deps
  depends_on:
  - restore-cache

- name: setup-aws-cli
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/docker:dind-cloud
  commands:
  - make deps-py VENV_TYPE=dkr
  depends_on:
  - restore-cache

- name: release
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/ci/node:12-cloud
  commands:
  - cat package.json | python -c "import sys, json; print(json.load(sys.stdin)['version'])" > VERSION
  - make pre-release ENV=prod
  environment:
    GITHUB_TOKEN:
      from_secret: GITHUB_TOKEN
  depends_on:
  - build

- name: rebuild-cache
  image: 164073796161.dkr.ecr.ap-northeast-1.amazonaws.com/thingspro-cloud/drone-ci-images:drone-cache
  settings:
    bucket: dlm-drone-ci-cache
    mount:
    - .cache
    rebuild: true
    region: ap-northeast-1
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_DEV_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_DEV_KEY
  depends_on:
  - notify

volumes:
- name: docker
  host:
    path: /var/run/docker.sock
- name: docker-token
  host:
    path: /root/.docker/config.json

trigger:
  branch:
  - master
  event:
  - push

...
